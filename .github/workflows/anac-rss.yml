name: ANAC RSS Feed Generator

on:
  schedule:
    - cron: '0 */6 * * *'  # Atualiza a cada 6 horas
  workflow_dispatch:

jobs:
  generate-feeds:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: '1.40.x'

      - name: Generate Feeds
        run: |
          cat << 'EOF' > script.ts
          import { Feed } from "https://esm.sh/feed@4.2.2";

          const ANAC_URL = "https://www.gov.br/anac/pt-br/noticias";
          
          async function main() {
            try {
              // 1. Fetch data
              const res = await fetch(ANAC_URL);
              const html = await res.text();
              const doc = new DOMParser().parseFromString(html, "text/html");

              // 2. Parse news
              const news = Array.from(doc.querySelectorAll("article.tileItem"))
                .slice(0, 20)
                .map((article) => ({
                  title: article.querySelector("h2 a")?.textContent?.trim() || "Sem t√≠tulo",
                  link: new URL(
                    article.querySelector("h2 a")?.getAttribute("href") || "/",
                    ANAC_URL
                  ).toString(),
                  description: article.querySelector("p.tileBody span")?.textContent?.trim() || "",
                  date: new Date(),
                }));

              // 3. Save JSON
              await Deno.writeTextFile(
                "anac.json",
                JSON.stringify({ updated: new Date().toISOString(), items: news }, null, 2)
              );

              // 4. Generate RSS
              const feed = new Feed({
                title: "ANAC Not√≠cias",
                description: "Feed RSS oficial",
                id: ANAC_URL,
                link: ANAC_URL,
                updated: new Date(),
              });

              news.forEach(item => feed.addItem({
                title: item.title,
                id: item.link,
                link: item.link,
                description: item.description,
                date: item.date,
              }));

              await Deno.writeTextFile("anac.rss.xml", feed.rss2());
              console.log("‚úÖ Feeds gerados!");

            } catch (error) {
              console.error("‚ùå Erro:", error);
              Deno.exit(1);
            }
          }

          await main();
          EOF

          deno run --allow-net --allow-write script.ts

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: anac-feeds
          path: |
            anac.json
            anac.rss.xml

      - name: Commit to Repository
        run: |
          mkdir -p feeds
          mv anac.json feeds/
          mv anac.rss.xml feeds/
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add feeds/
          git commit -m "üìå Update feeds [$(date +'%Y-%m-%d %H:%M')]" || echo "No changes"
          git push
